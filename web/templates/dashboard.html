{% extends "base.html" %}

{% block title %}Kontrol Paneli - Rota Motoru{% endblock %}
{% block page_title %}Kontrol Paneli{% endblock %}

{% block header_actions %}
<div style="display:flex;align-items:center;gap:10px;">
    <select id="optimization-mode">
        <option value="budget">Bütçe Dostu (daha az araç)</option>
        <option value="balanced" selected>Dengeli</option>
        <option value="employee">Personel Dostu (daha kısa yürüme)</option>
    </select>
    <button class="btn btn-success" onclick="generateRoutes()" id="generate-btn">Rotaları Oluştur</button>
    <button class="btn btn-primary" onclick="refreshStats()">Yenile</button>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Rota Genel Görünümü</h2>
    </div>
    <div class="card-body">
        <div id="overview-map" style="height: 540px; border-radius: 12px;z-index: 1;"></div>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <span class="stat-label">Toplam Personel</span>
        <span class="stat-value" id="stat-employees">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Aktif Personel</span>
        <span class="stat-value" id="stat-active">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Atanmamış</span>
        <span class="stat-value" id="stat-unassigned">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Verimlilik</span>
        <span class="stat-value" id="stat-efficiency">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Aktif Rotalar</span>
        <span class="stat-value" id="stat-routes">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Araçlar</span>
        <span class="stat-value" id="stat-vehicles">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Kümeler</span>
        <span class="stat-value" id="stat-clusters">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Bölgeler</span>
        <span class="stat-value" id="stat-zones">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Toplam Mesafe</span>
        <span class="stat-value" id="stat-distance">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Toplam Süre</span>
        <span class="stat-value" id="stat-duration">--</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const map = L.map('overview-map').setView([40.95, 29.2], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap, &copy; CARTO'
    }).addTo(map);

    let routeLayer = L.layerGroup().addTo(map);

    const officeIcon = L.divIcon({
        className: 'custom-marker office-marker',
        html: `<div style="background:#3699ff;width:20px;height:20px;border-radius:6px;border:1px solid #fff;display:flex;align-items:center;justify-content:center;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="white"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
        </div>`,
        iconSize: [20, 20], iconAnchor: [10, 10]
    });
    L.marker([40.837384, 29.412109], { icon: officeIcon }).addTo(map)
        .bindPopup('<b>Ofis</b>');

    async function refreshStats() {
        try {
            const res = await fetch('/api/stats');
            const data = await res.json();

            document.getElementById('stat-employees').textContent = data.total_employees;
            document.getElementById('stat-active').textContent = data.active_employees;
            document.getElementById('stat-unassigned').textContent = data.unassigned_employees;
            document.getElementById('stat-routes').textContent = data.total_routes;
            document.getElementById('stat-vehicles').textContent = data.total_vehicles;
            document.getElementById('stat-clusters').textContent = data.total_clusters;
            document.getElementById('stat-zones').textContent = data.total_zones;
            document.getElementById('stat-distance').textContent = data.total_distance_km;
            document.getElementById('stat-duration').textContent = Math.round(data.total_duration_min);
            document.getElementById('stat-efficiency').textContent =
                data.total_employees > 0 ?
                    ((data.active_employees - data.unassigned_employees) / data.active_employees * 100).toFixed(2) + '%' : '--';

            loadRoutes();
        } catch (err) {
            console.error('Error loading stats:', err);
        }
    }

    async function loadRoutes() {
        routeLayer.clearLayers();

        try {
            const res = await fetch('/api/routes');
            const routes = await res.json();

            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];

            routes.forEach((route, i) => {
                const color = colors[i % colors.length];

                const pathCoords = route.coordinates && route.coordinates.length > 1 ? route.coordinates : route.stops;
                if (pathCoords && pathCoords.length > 1) {
                    const latlngs = pathCoords.map(s => [s[0], s[1]]);
                    L.polyline(latlngs, {
                        color: color,
                        weight: 3,
                        opacity: 0.8
                    }).addTo(routeLayer);
                }

                if (route.center) {
                    const clusterIcon = L.divIcon({
                        className: 'custom-marker cluster-marker',
                        html: `<div style="background:${color};width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:bold;">${i + 1}</div>`,
                        iconSize: [20, 20]
                    });
                    L.marker([route.center[0], route.center[1]], { icon: clusterIcon }).addTo(routeLayer)
                        .bindPopup(`<b>Rota ${i + 1}</b><br>Mesafe: ${route.distance_km} km<br>Süre: ${Math.round(route.duration_min)} dk`);
                }
            });
        } catch (err) {
            console.error('Error loading routes:', err);
        }
    }

    async function loadOptimizationMode() {
        try {
            const res = await fetch('/api/optimization-mode');
            const data = await res.json();
            const sel = document.getElementById('optimization-mode');
            if (sel && data.current_mode) {
                sel.value = data.current_mode;
            }
        } catch (err) {
            console.error('Error loading optimization mode:', err);
        }
    }

    async function generateRoutes() {
        const btn = document.getElementById('generate-btn');
        const originalText = btn.textContent;
        const mode = document.getElementById('optimization-mode').value;

        try {
            btn.textContent = 'Oluşturuluyor...';
            btn.disabled = true;

            const res = await fetch('/api/generate-routes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode })
            });
            const data = await res.json();

            if (data.success) {
                await refreshStats();
                await loadRoutes();
                alert('Rotalar başarıyla oluşturuldu!');
            } else {
                alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
            }
        } catch (err) {
            console.error('Error generating routes:', err);
            alert('Rota oluşturulurken hata oluştu');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    loadOptimizationMode();
    refreshStats();
    loadRoutes();
</script>
{% endblock %}
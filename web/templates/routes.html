{% extends "base.html" %}

{% block title %}{{ t['rte_title'] }} - {{ t['app_title'] }}{% endblock %}
{% block page_title %}{{ t['rte_title'] }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
    .routes-layout {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 20px;
        height: calc(100vh - 140px);
    }

    .routes-sidebar {
        display: flex;
        flex-direction: column;
        gap: 16px;
        overflow-y: auto;
    }

    .route-map-container {
        height: 100%;
        min-height: 500px;
    }

    #route-map {
        height: 100%;
        border-radius: 4px;
    }

    .route-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .route-item:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    .route-item.selected {
        background: rgba(54, 153, 255, 0.1);
        border-left: 3px solid var(--accent-primary);
    }

    .route-actions {
        display: flex;
        gap: 6px;
    }

    .details-content {
        padding: 15px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-sidebar);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 15px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .info-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
    }

    .info-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .edit-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
    }

    .btn-success {
        background: #0bb783;
        color: white;
    }

    .btn-success:hover {
        background: #099268;
    }

    .help-text {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 10px;
    }

    .employee-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .employee-chip {
        padding: 4px 8px;
        background: var(--bg-card);
        border-radius: 3px;
        font-size: 11px;
        color: var(--text-secondary);
    }

    .leaflet-routing-container {
        display: none !important;
    }

    .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 12px 24px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-primary);
        z-index: 2000;
        animation: slideIn 0.3s ease;
    }

    .toast.success {
        border-left: 4px solid #0bb783;
    }

    .toast.error {
        border-left: 4px solid #f64e60;
    }

    @keyframes slideIn {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }



    .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    /* Reassign mode styles */
    @keyframes pulse-marker {

        0%,
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(54, 153, 255, 0.7);
        }

        50% {
            transform: scale(1.3);
            box-shadow: 0 0 0 8px rgba(54, 153, 255, 0);
        }
    }

    .reassign-active-marker div {
        animation: pulse-marker 1.2s ease-in-out infinite !important;
        background: #3699ff !important;
        width: 14px !important;
        height: 14px !important;
    }

    .reassign-target div {
        cursor: pointer !important;
        box-shadow: 0 0 8px 3px rgba(16, 185, 129, 0.8) !important;
        width: 14px !important;
        height: 14px !important;
    }

    .reassign-banner {
        position: fixed;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(54, 153, 255, 0.95);
        color: #fff;
        padding: 10px 24px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        z-index: 2000;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease;
    }

    .reassign-banner button {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.4);
        color: #fff;
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .reassign-banner button:hover {
        background: rgba(255, 255, 255, 0.35);
    }

    .reassign-cursor {
        cursor: crosshair !important;
    }

    .reassign-cursor .leaflet-interactive {
        cursor: crosshair !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="routes-layout">
    <!-- Route List Sidebar -->
    <div class="routes-sidebar">
        <div class="card" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
            <div class="card-header">
                <h2>{{ t['sidebar_all_rte'] }}</h2>
                <span class="badge" id="route-count">0</span>
            </div>
            <div class="card-body" style="overflow-y:auto;flex:1;padding:0;">
                <div id="routes-container">
                    <div class="loading" style="padding:20px;">{{ t['msg_loading_rte'] }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map -->
    <div class="card route-map-container">
        <div class="card-header">
            <h2 id="map-title">{{ t['map_select_rte'] }}</h2>
        </div>
        <div id="route-map"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script>
    let routeMap = null;
    let routes = [];
    let currentLayer = null;
    let backgroundPolylines = [];
    let currentRouteIndex = -1;
    let routingControl = null;
    let lastCalculatedRoute = null;
    let originalWaypoints = [];
    let isEditMode = false;
    const officeLocation = [40.837384, 29.412109];

    // Reassign mode state
    let reassignMode = false;
    let reassignEmployeeId = null;
    let reassignEmployeeName = '';
    let reassignEmployeeMarker = null;
    let reassignBusStopMarkers = [];
    let reassignBanner = null;
    let currentClusterData = null;  // keep loaded cluster for re-rendering

    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#FF9FF3', '#54A0FF'];

    // Initialize map
    function initMap() {
        routeMap = L.map('route-map').setView([40.95, 29.2], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap, &copy; CARTO'
        }).addTo(routeMap);

        L.marker(officeLocation, {
            icon: L.divIcon({ className: 'office-icon', html: '<div style="background:#6366f1;width:12px;height:12px;border-radius:50%;border:2px solid #fff;"></div>', iconSize: [12, 12] })
        }).addTo(routeMap).bindPopup('<b>{{ t["office"] }}</b>');
    }

    async function loadRoutes() {
        try {
            const res = await fetch('/api/routes');
            routes = await res.json();
            document.getElementById('route-count').textContent = routes.length;
            renderRouteList();
            renderAllRoutesOnMap();
        } catch (err) {
            console.error('Error loading routes:', err);
            document.getElementById('routes-container').innerHTML = '<div class="error" style="padding:20px;">{{ t["msg_no_rte"] }}</div>';
        }
    }

    function renderRouteList() {
        const container = document.getElementById('routes-container');

        if (routes.length === 0) {
            container.innerHTML = '<div class="empty" style="padding:20px;">{{ t["msg_no_rte"] }}</div>';
            return;
        }

        container.innerHTML = routes.map((r, i) => `
            <div class="route-item" data-index="${i}">
                <div class="route-color" style="background:${colors[i % colors.length]};width:10px;height:10px;border-radius:50%;"></div>
                <div class="route-info" style="flex:1;display:flex;flex-direction:column;justify-content:center;" onclick="selectRoute(${i})">
                    <span class="route-name" style="font-weight:600;">{{ t['route_name_fmt'].format('${i + 1}') }}</span>
                    <span class="route-meta" style="font-size:12px;color:var(--text-muted);">${r.distance_km} {{ t['unit_km'] }} <span style="color:var(--border-light); margin:0 4px;">|</span> ${Math.round(r.duration_min)} {{ t['unit_min'] }} <span style="color:var(--border-light); margin:0 4px;">|</span> ${r.employee_count} {{ t['lbl_employees'] }}</span>
                </div>
                <div class="route-actions">
                    <button class="btn btn-sm btn-secondary" onclick="showRouteDetails(${i})">{{ t['btn_details'] }}</button>
                </div>
            </div>
            <div id="details-${i}" class="details-content" style="display:none;">
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">{{ t['dtl_distance'] }}</span>
                        <span class="info-value">${r.distance_km} {{ t['unit_km'] }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{{ t['dtl_duration'] }}</span>
                        <span class="info-value">${Math.round(r.duration_min)} {{ t['unit_min'] }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{{ t['dtl_stops'] }}</span>
                        <span class="info-value">${r.stop_count}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{{ t['dtl_employees'] }}</span>
                        <span class="info-value">${r.employee_count}</span>
                    </div>
                </div>
                <div>
                    <span class="info-label">{{ t['dtl_employees'] }}</span>
                    <div id="employees-${i}" class="employee-chips" style="margin-top:6px;">{{ t['loading'] }}</div>
                </div>
                <div class="edit-actions">
                    <button class="btn btn-sm btn-primary" onclick="enableEditMode(${i})">{{ t['btn_edit_route'] }}</button>
                    <button class="btn btn-sm btn-secondary" onclick="closeDetails(${i})">{{ t['btn_close'] }}</button>
                </div>
                <p class="help-text">{{ t['help_drag'] }}</p>
            </div>
        `).join('');
    }

    function renderAllRoutesOnMap() {
        // Clear existing background polylines
        backgroundPolylines.forEach(p => routeMap.removeLayer(p));
        backgroundPolylines = [];

        routes.forEach((route, i) => {
            const color = colors[i % colors.length];
            const pathCoords = route.coordinates && route.coordinates.length > 1 ? route.coordinates : route.stops;
            if (pathCoords && pathCoords.length > 1) {
                const latlngs = pathCoords.map(s => [s[0], s[1]]);
                const polyline = L.polyline(latlngs, { color: color, weight: 3, opacity: 0.6 }).addTo(routeMap);
                backgroundPolylines.push(polyline);

                // Add click handler to open route details
                polyline.on('click', () => showRouteDetails(i));

                // Highlight on hover
                polyline.on('mouseover', function () {
                    this.setStyle({ weight: 6, opacity: 1 });
                });
                polyline.on('mouseout', function () {
                    if (currentRouteIndex !== i) {
                        this.setStyle({ weight: 3, opacity: 0.6 });
                    }
                });
            }
        });
    }

    function selectRoute(index) {
        const route = routes[index];
        const color = colors[index % colors.length];
        currentRouteIndex = index;

        // Update UI
        document.querySelectorAll('.route-item').forEach(el => el.classList.remove('selected'));
        document.querySelector(`.route-item[data-index="${index}"]`)?.classList.add('selected');
        document.getElementById('map-title').textContent = '{{ t["route_name_fmt"] }}'.replace('{}', index + 1);

        // Reset all background polylines first
        backgroundPolylines.forEach(p => p.setStyle({ weight: 3, opacity: 0.6 }));

        // Bold the background polyline for this route
        if (backgroundPolylines[index]) {
            backgroundPolylines[index].setStyle({ weight: 6, opacity: 1 });
        }

        // Clear previous
        if (currentLayer) routeMap.removeLayer(currentLayer);
        if (routingControl) {
            routeMap.removeControl(routingControl);
            routingControl = null;
        }

        // Draw route
        const pathCoords = route.coordinates && route.coordinates.length > 1 ? route.coordinates : route.stops;
        if (pathCoords && pathCoords.length > 1) {
            const latlngs = pathCoords.map(s => [s[0], s[1]]);
            currentLayer = L.layerGroup().addTo(routeMap);

            L.polyline(latlngs, { color: color, weight: 5, opacity: 1 }).addTo(currentLayer);

            route.stops.forEach((stop, i) => {
                let icon;
                if (i === 0) {
                    icon = L.divIcon({ className: 'start', html: '<div style="background:#10b981;width:12px;height:12px;border-radius:50%;border:2px solid #fff;"></div>', iconSize: [12, 12] });
                } else if (i === route.stops.length - 1) {
                    icon = L.divIcon({ className: 'end', html: '<div style="background:#6366f1;width:12px;height:12px;border-radius:50%;border:2px solid #fff;"></div>', iconSize: [12, 12] });
                } else {
                    icon = L.divIcon({ className: 'stop', html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;"></div>`, iconSize: [10, 10] });
                }
                L.marker([stop[0], stop[1]], { icon }).addTo(currentLayer).bindPopup(`Durak ${i + 1}`);
            });

            // Show ALL bus stops along the route
            if (route.bus_stops && route.bus_stops.length > 0) {
                // Fetch stop names
                const stopMarkers = [];
                route.bus_stops.forEach((stop, i) => {
                    const busIcon = L.divIcon({
                        className: 'bus-stop',
                        html: '<div style="background:#f59e0b;width:8px;height:8px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 4px rgba(245,158,11,0.6);"></div>',
                        iconSize: [8, 8],
                        iconAnchor: [4, 4]
                    });
                    const marker = L.marker([stop[0], stop[1]], { icon: busIcon })
                        .addTo(currentLayer)
                        .bindPopup(`Otobüs Durağı ${i + 1}`);
                    stopMarkers.push({ marker, stop });
                });

                // Resolve stop names asynchronously
                fetch('/api/stops/names', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ coordinates: route.bus_stops })
                }).then(r => r.json()).then(names => {
                    stopMarkers.forEach(({ marker, stop }, i) => {
                        const key = `${stop[0].toFixed(5)},${stop[1].toFixed(5)}`;
                        const name = names[key] || 'Otobüs Durağı';
                        marker.setPopupContent(`<b>${name}</b><br>${stopMarkers.length} duraktan ${i + 1}. durak`);
                    });
                }).catch(() => { });
            }

            routeMap.fitBounds(latlngs);
        }

        isEditMode = false;
    }

    async function showRouteDetails(index) {
        // Select the route first
        selectRoute(index);

        // Toggle details panel
        const detailsEl = document.getElementById(`details-${index}`);
        const isVisible = detailsEl.style.display !== 'none';

        // Hide all details first
        document.querySelectorAll('.details-content').forEach(el => el.style.display = 'none');

        // Scroll to the route item in sidebar
        const routeItem = document.querySelector(`.route-item[data-index="${index}"]`);
        if (routeItem) {
            routeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        if (!isVisible) {
            detailsEl.style.display = 'block';

            // Fetch route with bus stops if not already loaded
            const route = routes[index];
            if (!route.bus_stops || route.bus_stops.length === 0) {
                try {
                    const routeRes = await fetch(`/api/routes/${route.cluster_id}`);
                    const routeData = await routeRes.json();
                    if (!routeData.error && routeData.bus_stops) {
                        // Update the route in the routes array with bus stops
                        routes[index].bus_stops = routeData.bus_stops;
                        routes[index].bus_stop_count = routeData.bus_stop_count;
                    }
                } catch (err) {
                    console.error('Error loading route details:', err);
                }
            }

            // Add bus stop markers to map if we have them
            if (currentLayer && route.bus_stops && route.bus_stops.length > 0) {
                // Fetch real names for all bus stops
                fetch('/api/stops/names', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ coordinates: route.bus_stops })
                })
                    .then(res => res.json())
                    .then(names => {
                        route.bus_stops.forEach((stop, idx) => {
                            const key = `${stop[0].toFixed(5)},${stop[1].toFixed(5)}`;
                            const name = names[key] || `Otobüs Durağı ${idx + 1}`;

                            const busIcon = L.divIcon({
                                className: 'bus-stop-icon',
                                html: '<div style="background:#10b981;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div>',
                                iconSize: [12, 12],
                                iconAnchor: [6, 6]
                            });
                            L.marker([stop[0], stop[1]], { icon: busIcon })
                                .addTo(currentLayer)
                                .bindPopup(`<b>${name}</b><br>Lat: ${stop[0].toFixed(5)}<br>Lon: ${stop[1].toFixed(5)}`);
                        });
                    })
                    .catch(err => {
                        console.error('Error fetching stop names:', err);
                        // Fallback: show without names
                        route.bus_stops.forEach((stop, idx) => {
                            const busIcon = L.divIcon({
                                className: 'bus-stop-icon',
                                html: '<div style="background:#10b981;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div>',
                                iconSize: [12, 12],
                                iconAnchor: [6, 6]
                            });
                            L.marker([stop[0], stop[1]], { icon: busIcon })
                                .addTo(currentLayer)
                                .bindPopup(`<b>Otobüs Durağı ${idx + 1}</b><br>Enlem: ${stop[0].toFixed(5)}<br>Boylam: ${stop[1].toFixed(5)}`);
                        });
                    });
            }

            // Load employees
            try {
                const res = await fetch(`/api/clusters/${route.cluster_id}`);
                const cluster = await res.json();

                if (cluster.error) {
                    document.getElementById(`employees-${index}`).innerHTML = '<span style="color:var(--text-muted);">Küme bulunamadı</span>';
                    return;
                }

                if (cluster.employees && cluster.employees.length > 0) {
                    // Show employee names in details panel
                    document.getElementById(`employees-${index}`).innerHTML = cluster.employees.map(e =>
                        `<span class="employee-chip">${e.name}</span>`
                    ).join('');

                    // Add markers to map
                    if (currentLayer) {
                        // Collect unique pickup points (bus stops)
                        const pickupPoints = new Map();
                        cluster.employees.forEach(emp => {
                            if (emp.pickup_point) {
                                const key = `${emp.pickup_point[0].toFixed(5)},${emp.pickup_point[1].toFixed(5)}`;
                                if (!pickupPoints.has(key)) {
                                    pickupPoints.set(key, { lat: emp.pickup_point[0], lon: emp.pickup_point[1], employees: [] });
                                }
                                pickupPoints.get(key).employees.push(emp.name);
                            }
                        });

                        // Add bus stop markers with real names (only for stops that exist in OSM)
                        if (pickupPoints.size > 0) {
                            // Fetch real stop names from API
                            const coords = Array.from(pickupPoints.values()).map(s => [s.lat, s.lon]);
                            fetch('/api/stops/names', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ coordinates: coords })
                            })
                                .then(res => res.json())
                                .then(stopNames => {
                                    pickupPoints.forEach((stop, key) => {
                                        const stopName = stopNames[key];
                                        // Only show marker if it's a real bus stop (has a name from OSM, not generic fallback)
                                        if (stopName && stopName !== 'Bus Stop') {
                                            const stopIcon = L.divIcon({
                                                className: 'bus-stop-marker',
                                                html: '<div style="background:#10b981;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div>',
                                                iconSize: [12, 12],
                                                iconAnchor: [6, 6]
                                            });
                                            L.marker([stop.lat, stop.lon], { icon: stopIcon })
                                                .addTo(currentLayer)
                                                .bindPopup(`<b>${stopName}</b><br>${stop.employees.length} personel:<br>${stop.employees.join('<br>')}`);
                                        }
                                    });
                                })
                                .catch(err => {
                                    console.error('Error fetching stop names:', err);
                                });
                        }

                        // Add employee home markers and lines to their pickup points
                        currentClusterData = cluster;
                        cluster.employees.forEach(emp => {
                            const empIcon = L.divIcon({
                                className: 'employee-marker',
                                html: '<div style="background:#f64e60;width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 4px rgba(246,78,96,0.6);"></div>',
                                iconSize: [10, 10],
                                iconAnchor: [5, 5]
                            });

                            // Show distance to pickup point (from OSRM)
                            let popupContent = `<b>${emp.name}</b><br>Ev konumu`;
                            if (emp.walking_distance != null) {
                                popupContent += `<br><br><b>Durağa Mesafe:</b> ${Math.round(emp.walking_distance)} m`;
                            } else if (emp.pickup_point) {
                                popupContent += `<br><br><i>Mesafe bilgisi yok</i>`;
                            }
                            popupContent += `<br><button class="btn btn-sm" style="margin-top:8px;background:#3699ff;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;" onclick="startReassign(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')">Durağı Değiştir</button>`;

                            const marker = L.marker([emp.lat, emp.lon], { icon: empIcon, zIndexOffset: 1000 })
                                .addTo(currentLayer)
                                .bindPopup(popupContent);
                            marker._empId = emp.id;

                            // Draw line from employee to their pickup point
                            if (emp.pickup_point) {
                                L.polyline(
                                    [[emp.lat, emp.lon], [emp.pickup_point[0], emp.pickup_point[1]]],
                                    {
                                        color: '#f64e60',
                                        weight: 2,
                                        opacity: 0.7,
                                        dashArray: '4, 6'
                                    }
                                ).addTo(currentLayer);
                            }
                        });
                    }
                } else {
                    document.getElementById(`employees-${index}`).innerHTML = '<span style="color:var(--text-muted);">Atanmış personel yok</span>';
                }
            } catch (err) {
                console.error('Error loading cluster:', err);
                document.getElementById(`employees-${index}`).innerHTML = '<span style="color:var(--text-muted);">Personeller yüklenirken hata oluştu</span>';
            }
        }
    }

    function closeDetails(index) {
        document.getElementById(`details-${index}`).style.display = 'none';
        if (isEditMode) {
            disableEditMode();
        }

        // Remove selection styling
        document.querySelectorAll('.route-item').forEach(el => el.classList.remove('selected'));
        document.getElementById('map-title').textContent = '{{ t["sidebar_all_rte"] }}';

        // Clear focused route layer and show all routes
        if (currentLayer) {
            routeMap.removeLayer(currentLayer);
            currentLayer = null;
        }

        // Reset all background polylines to default style
        backgroundPolylines.forEach(p => p.setStyle({ weight: 3, opacity: 0.6 }));

        currentRouteIndex = -1;
    }

    let editGhostLayer = null;

    function enableEditMode(index) {
        selectRoute(index);

        const route = routes[index];
        const color = colors[index % colors.length];

        // Keep old route as a faint ghost instead of removing it
        if (currentLayer) {
            editGhostLayer = currentLayer;
            editGhostLayer.eachLayer(layer => {
                if (layer.setStyle) layer.setStyle({ opacity: 0.15, fillOpacity: 0.1, weight: 3 });
                if (layer.getElement) {
                    const el = layer.getElement();
                    if (el) el.style.opacity = '0.15';
                }
            });
            currentLayer = null;
        }
        // Also fade the background polyline for this route
        if (backgroundPolylines[index]) {
            backgroundPolylines[index].setStyle({ opacity: 0.1, weight: 2 });
        }

        // Setup waypoints
        const waypoints = route.stops.map(s => L.latLng(s[0], s[1]));
        originalWaypoints = waypoints.map(wp => L.latLng(wp.lat, wp.lng));

        // Create routing control
        routingControl = L.Routing.control({
            router: L.Routing.osrmv1({ serviceUrl: 'http://localhost:5001/route/v1' }),
            waypoints: waypoints,
            routeWhileDragging: true,
            draggableWaypoints: true,
            addWaypoints: true,  // Enable adding waypoints by dragging anywhere on the line
            fitSelectedRoutes: true,
            showAlternatives: false,
            lineOptions: {
                styles: [{ color: color, opacity: 0.9, weight: 6 }],
                extendToWaypoints: true,
                missingRouteTolerance: 0
            },
            createMarker: function (i, waypoint, n) {
                return L.marker(waypoint.latLng, {
                    draggable: true,
                    icon: L.divIcon({
                        className: 'waypoint-marker',
                        html: `<div style="background:${color};color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:11px;border:2px solid #fff;">${i + 1}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).bindPopup(`<b>Durak ${i + 1}</b><br>Taşımak için sürükleyin`);
            }
        }).addTo(routeMap);

        routingControl.on('routesfound', function (e) {
            lastCalculatedRoute = e.routes[0];
        });

        isEditMode = true;

        // Update details panel with edit buttons
        const detailsEl = document.getElementById(`details-${index}`);
        detailsEl.querySelector('.edit-actions').innerHTML = `
            <button class="btn btn-sm btn-success" onclick="saveRouteChanges(${index})">{{ t['btn_save'] }}</button>
            <button class="btn btn-sm btn-secondary" onclick="resetRouteEdit(${index})">{{ t['btn_reset'] }}</button>
            <button class="btn btn-sm btn-secondary" onclick="cancelEdit(${index})">{{ t['btn_cancel'] }}</button>
        `;

        showToast('Düzenleme modu açıldı — ara noktaları sürükleyerek rotayı değiştirin', 'info');
    }



    function disableEditMode() {
        if (routingControl) {
            routeMap.removeControl(routingControl);
            routingControl = null;
        }
        if (editGhostLayer) {
            routeMap.removeLayer(editGhostLayer);
            editGhostLayer = null;
        }
        isEditMode = false;

        // Redraw static route
        if (currentRouteIndex >= 0) {
            selectRoute(currentRouteIndex);
        }
    }

    function resetRouteEdit(index) {
        if (routingControl && originalWaypoints.length > 0) {
            routingControl.setWaypoints(originalWaypoints);
            showToast('Rota orijinaline sıfırlandı', 'info');
        }
    }

    function cancelEdit(index) {
        disableEditMode();
        showRouteDetails(index);

        // Restore original edit actions
        const detailsEl = document.getElementById(`details-${index}`);
        detailsEl.querySelector('.edit-actions').innerHTML = `
            <button class="btn btn-sm btn-primary" onclick="enableEditMode(${index})">Rotayı Düzenle</button>
            <button class="btn btn-sm btn-secondary" onclick="closeDetails(${index})">Kapat</button>
        `;
    }

    async function saveRouteChanges(index) {
        if (!routingControl || !lastCalculatedRoute) {
            showToast('Kaydedilecek değişiklik yok', 'error');
            return;
        }

        // Show loading state
        const detailsEl = document.getElementById(`details-${index}`);
        const saveBtn = detailsEl.querySelector('.btn-success');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<span class="spinner"></span>Kaydediliyor...';
        saveBtn.disabled = true;

        const waypoints = routingControl.getWaypoints()
            .filter(wp => wp.latLng)
            .map(wp => [wp.latLng.lat, wp.latLng.lng]);

        const coordinates = lastCalculatedRoute.coordinates.map(c => [c.lat, c.lng]);
        const distance_km = parseFloat((lastCalculatedRoute.summary.totalDistance / 1000).toFixed(2));
        const duration_min = Math.round(lastCalculatedRoute.summary.totalTime / 60);

        const route = routes[index];

        try {
            const res = await fetch(`/api/routes/${route.cluster_id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stops: waypoints,
                    coordinates: coordinates,
                    distance_km: distance_km,
                    duration_min: duration_min
                })
            });

            if (res.ok) {
                const result = await res.json();
                const reassignedCount = result.employees_reassigned || 0;
                const busStopCount = result.bus_stop_count || 0;
                showToast(`Rota kaydedildi! ${reassignedCount} personel yeniden atandı, ${busStopCount} otobüs durağı bulundu.`, 'success');

                // Update local data
                routes[index].stops = waypoints;
                routes[index].coordinates = coordinates;
                routes[index].distance_km = distance_km;
                routes[index].duration_min = duration_min;
                routes[index].stop_count = waypoints.length;
                routes[index].optimized = false;
                routes[index].bus_stops = result.bus_stops || [];
                routes[index].bus_stop_count = (result.bus_stops || []).length;

                originalWaypoints = waypoints.map(s => L.latLng(s[0], s[1]));

                // Update UI
                renderRouteList();
                renderAllRoutesOnMap();
                cancelEdit(index);
            } else {
                showToast('Rota kaydedilirken hata oluştu', 'error');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        } catch (err) {
            console.error('Error saving route:', err);
            showToast('Rota kaydedilirken hata oluştu', 'error');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }

    function showToast(message, type = 'info') {
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // =========================================================================
    // Stop Reassignment Mode
    // =========================================================================

    function startReassign(empId, empName) {
        if (reassignMode) cancelReassign();

        reassignMode = true;
        reassignEmployeeId = empId;
        reassignEmployeeName = empName;

        // Close any open popup
        routeMap.closePopup();

        // Highlight the employee marker
        if (currentLayer) {
            currentLayer.eachLayer(layer => {
                if (layer._empId === empId && layer.getElement) {
                    const el = layer.getElement();
                    if (el) el.classList.add('reassign-active-marker');
                    reassignEmployeeMarker = layer;
                }
            });
        }

        // Make bus stop markers glow and register click handlers
        reassignBusStopMarkers = [];
        const route = routes[currentRouteIndex];
        if (route && route.bus_stops && route.bus_stops.length > 0) {
            route.bus_stops.forEach((stop) => {
                const targetIcon = L.divIcon({
                    className: 'bus-stop-icon reassign-target',
                    html: '<div style="background:#10b981;width:14px;height:14px;border-radius:50%;border:2px solid #fff;"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                const m = L.marker([stop[0], stop[1]], { icon: targetIcon, zIndexOffset: 2000 })
                    .addTo(currentLayer)
                    .on('click', () => confirmReassign(stop[0], stop[1]));
                reassignBusStopMarkers.push(m);
            });
        }

        // Also allow clicking route stops (waypoints) as targets
        if (route && route.stops) {
            route.stops.forEach((stop) => {
                const targetIcon = L.divIcon({
                    className: 'stop-icon reassign-target',
                    html: '<div style="background:#f59e0b;width:14px;height:14px;border-radius:50%;border:2px solid #fff;"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                const m = L.marker([stop[0], stop[1]], { icon: targetIcon, zIndexOffset: 2000 })
                    .addTo(currentLayer)
                    .on('click', () => confirmReassign(stop[0], stop[1]));
                reassignBusStopMarkers.push(m);
            });
        }

        // Show instruction banner
        reassignBanner = document.createElement('div');
        reassignBanner.className = 'reassign-banner';
        reassignBanner.innerHTML = `<span><b>${empName}</b> için haritada herhangi bir yere tıklayın — veya vurgulanan bir durağı seçin</span><button onclick="cancelReassign()">İptal (Esc)</button>`;
        document.body.appendChild(reassignBanner);

        // Allow clicking anywhere on the map
        routeMap.getContainer().classList.add('reassign-cursor');
        routeMap.on('click', onMapClickReassign);
    }

    function onMapClickReassign(e) {
        if (!reassignMode) return;
        confirmReassign(e.latlng.lat, e.latlng.lng);
    }

    async function confirmReassign(lat, lon) {
        if (!reassignMode) return;

        const empId = reassignEmployeeId;
        const empName = reassignEmployeeName;

        // Remove banner immediately for responsiveness
        cancelReassignUI();

        try {
            const res = await fetch(`/api/employees/${empId}/pickup-point`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat, lon })
            });

            if (res.ok) {
                showToast(`${empName} yeni durağa atandı`, 'success');
                // Refresh the route details view so markers & lines update
                if (currentRouteIndex >= 0) {
                    showRouteDetails(currentRouteIndex);
                }
            } else {
                const err = await res.json();
                showToast('Error: ' + (err.error || 'Unknown error'), 'error');
            }
        } catch (err) {
            console.error('Error reassigning stop:', err);
            showToast('Durak atanırken hata oluştu', 'error');
        }
    }

    function cancelReassign() {
        cancelReassignUI();
        showToast('Atama iptal edildi', 'info');
    }

    function cancelReassignUI() {
        reassignMode = false;
        reassignEmployeeId = null;
        reassignEmployeeName = '';

        // Remove highlight from employee marker
        if (reassignEmployeeMarker && reassignEmployeeMarker.getElement) {
            const el = reassignEmployeeMarker.getElement();
            if (el) el.classList.remove('reassign-active-marker');
        }
        reassignEmployeeMarker = null;

        // Remove target bus stop markers
        reassignBusStopMarkers.forEach(m => {
            if (currentLayer) currentLayer.removeLayer(m);
        });
        reassignBusStopMarkers = [];

        // Remove map click handler and cursor
        routeMap.off('click', onMapClickReassign);
        routeMap.getContainer().classList.remove('reassign-cursor');

        // Remove banner
        if (reassignBanner) {
            reassignBanner.remove();
            reassignBanner = null;
        }
    }

    // Escape key to cancel reassign
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && reassignMode) {
            cancelReassign();
        }
    });

    // Initialize
    initMap();
    loadRoutes();
</script>
{% endblock %}
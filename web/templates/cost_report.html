{% extends "base.html" %}

{% block title %}{{ t['rpt_title'] }} - {{ t['app_title'] }}{% endblock %}
{% block page_title %}{{ t['rpt_title'] }}{% endblock %}

{% block header_actions %}
<div style="display:flex;align-items:center;gap:10px;">
    <button class="btn btn-primary" onclick="calculateReport()" id="calc-btn">{{ t['btn_calculate'] }}</button>
    <button class="btn btn-success" onclick="window.print()">{{ t['btn_download_pdf'] }}</button>
</div>
{% endblock %}

{% block content %}

<!-- Print Header (hidden on screen, shown on print) -->
<div class="print-header">
    <h1>{{ t['rpt_header'] }}</h1>
    <p class="print-date"></p>
</div>

<!-- System Stats Bar -->
<div class="stats-list" id="system-stats">
    <div class="stat-item"><span class="stat-label">{{ t['lbl_st_active_emp'] }}</span><span class="stat-value"
            id="sys-employees">--</span></div>
    <div class="stat-item"><span class="stat-label">{{ t['lbl_st_vehicles'] }}</span><span class="stat-value"
            id="sys-vehicles">--</span></div>
    <div class="stat-item"><span class="stat-label">{{ t['lbl_st_routes'] }}</span><span class="stat-value"
            id="sys-routes">--</span>
    </div>
    <div class="stat-item"><span class="stat-label">{{ t['lbl_st_daily_km'] }}</span><span class="stat-value"
            id="sys-daily-km">--</span></div>
    <div class="stat-item"><span class="stat-label">{{ t['lbl_st_monthly_km'] }}</span><span class="stat-value"
            id="sys-monthly-km">--</span></div>
</div>

<!-- Editable Parameters -->
<div class="card cr-params-card">
    <div class="card-header">
        <h2>{{ t['card_params'] }}</h2>
        <span style="font-size:12px;color:var(--text-muted);">{{ t['help_params_edit'] }}</span>
    </div>
    <div class="card-body">
        <div class="cr-params-grid">
            <div class="cr-param-group">
                <h3 class="cr-param-title">{{ t['sect_personnel'] }}</h3>
                <label>{{ t['lbl_driver_salary'] }}<input type="number" id="p-driver-salary" value="35000"></label>
                <label>{{ t['lbl_sgk'] }}<input type="number" id="p-sgk-rate" value="22.5" step="0.1"></label>
                <label>{{ t['lbl_unemployment'] }}<input type="number" id="p-unemployment" value="2" step="0.1"></label>
            </div>
            <div class="cr-param-group">
                <h3 class="cr-param-title">{{ t['sect_vehicle'] }}</h3>
                <label>{{ t['lbl_vehicle_rent'] }}<input type="number" id="p-vehicle-rent" value="25000"></label>
                <label>{{ t['lbl_maintenance'] }}<input type="number" id="p-maintenance" value="8000"></label>
                <label>{{ t['lbl_mtv'] }}<input type="number" id="p-mtv" value="1500"></label>
            </div>
            <div class="cr-param-group">
                <h3 class="cr-param-title">{{ t['sect_fuel'] }}</h3>
                <label>{{ t['lbl_fuel_price'] }}<input type="number" id="p-fuel-price" value="43.5" step="0.1"></label>
                <label>{{ t['lbl_fuel_consumption'] }}<input type="number" id="p-fuel-consumption" value="15"
                        step="0.1"></label>
            </div>
            <div class="cr-param-group">
                <h3 class="cr-param-title">{{ t['sect_operation'] }}</h3>
                <label>{{ t['lbl_working_days'] }}<input type="number" id="p-working-days" value="22"></label>
                <label>{{ t['lbl_trips'] }}<input type="number" id="p-trips" value="2"></label>
                <label>{{ t['lbl_contract_months'] }}<input type="number" id="p-contract-months" value="12"></label>
            </div>
            <div class="cr-param-group">
                <h3 class="cr-param-title">{{ t['sect_tax_profit'] }}</h3>
                <label>{{ t['lbl_overhead'] }}<input type="number" id="p-overhead" value="5" step="0.1"></label>
                <label>{{ t['lbl_profit'] }}<input type="number" id="p-profit" value="10" step="0.1"></label>
                <label>{{ t['lbl_kdv'] }}<input type="number" id="p-kdv" value="20" step="0.1"></label>
                <label>{{ t['lbl_stamp'] }}<input type="number" id="p-stamp" value="0.948" step="0.001"></label>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="stats-grid cr-summary-grid" id="summary-cards">
    <div class="stat-card">
        <span class="stat-label">{{ t['row_grand_total'] }}</span>
        <span class="stat-value" id="sum-monthly">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">{{ t['row_cost_per_emp'] }}</span>
        <span class="stat-value" id="sum-per-emp">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">{{ t['row_cost_per_veh'] }}</span>
        <span class="stat-value" id="sum-per-vehicle">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">{{ t['row_cost_per_km'] }}</span>
        <span class="stat-value" id="sum-per-km">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">{{ t['row_contract_val'] }}</span>
        <span class="stat-value" id="sum-contract">--</span>
    </div>
</div>

<!-- Detailed Breakdown Table -->
<div class="card">
    <div class="card-header">
        <h2>{{ t['card_breakdown'] }}</h2>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="data-table cr-table" id="breakdown-table">
                <thead>
                    <tr>
                        <th style="width:40%">{{ t['tbl_item'] }}</th>
                        <th style="width:20%">{{ t['tbl_unit_price'] }}</th>
                        <th style="width:15%">{{ t['tbl_qty'] }}</th>
                        <th style="width:25%;text-align:right">{{ t['tbl_total'] }} (₺)</th>
                    </tr>
                </thead>
                <tbody id="breakdown-body">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Contract Summary -->
<div class="card">
    <div class="card-header">
        <h2>{{ t['card_contract'] }}</h2>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="data-table cr-table" id="contract-table">
                <thead>
                    <tr>
                        <th style="width:60%">Açıklama</th>
                        <th style="width:40%;text-align:right">Tutar (₺)</th>
                    </tr>
                </thead>
                <tbody id="contract-body">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const fmt = (n) => new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    const fmtInt = (n) => new Intl.NumberFormat('tr-TR').format(n);

    async function calculateReport() {
        const btn = document.getElementById('calc-btn');
        btn.textContent = '{{ t["lbl_calculating"] }}';
        btn.disabled = true;

        try {
            const params = new URLSearchParams({
                driver_salary: document.getElementById('p-driver-salary').value,
                sgk_rate: document.getElementById('p-sgk-rate').value,
                unemployment_rate: document.getElementById('p-unemployment').value,
                vehicle_rent: document.getElementById('p-vehicle-rent').value,
                maintenance: document.getElementById('p-maintenance').value,
                mtv: document.getElementById('p-mtv').value,
                fuel_price: document.getElementById('p-fuel-price').value,
                fuel_consumption: document.getElementById('p-fuel-consumption').value,
                working_days: document.getElementById('p-working-days').value,
                trips_per_day: document.getElementById('p-trips').value,
                contract_months: document.getElementById('p-contract-months').value,
                overhead_rate: document.getElementById('p-overhead').value,
                profit_rate: document.getElementById('p-profit').value,
                kdv_rate: document.getElementById('p-kdv').value,
                stamp_tax_rate: document.getElementById('p-stamp').value,
            });

            const res = await fetch('/api/cost-report?' + params.toString());
            const data = await res.json();

            if (data.error) { alert('Hata: ' + data.error); return; }

            renderReport(data);
        } catch (err) {
            console.error(err);
            alert('{{ t["msg_calc_error"] }}');
        } finally {
            btn.textContent = '{{ t["btn_calculate"] }}';
            btn.disabled = false;
        }
    }

    function renderReport(data) {
        const sys = data.system;
        const bd = data.breakdown;
        const ct = data.contract;

        // System stats
        document.getElementById('sys-employees').textContent = fmtInt(sys.active_employees);
        document.getElementById('sys-vehicles').textContent = fmtInt(sys.vehicle_count);
        document.getElementById('sys-routes').textContent = fmtInt(sys.route_count);
        document.getElementById('sys-daily-km').textContent = fmt(sys.daily_km);
        document.getElementById('sys-monthly-km').textContent = fmt(sys.monthly_km);

        // Summary cards
        document.getElementById('sum-monthly').textContent = '₺' + fmt(bd.grand_total_monthly);
        document.getElementById('sum-per-emp').textContent = '₺' + fmt(ct.per_employee_monthly);
        document.getElementById('sum-per-vehicle').textContent = '₺' + fmt(ct.per_vehicle_monthly);
        document.getElementById('sum-per-km').textContent = '₺' + fmt(ct.per_km);
        document.getElementById('sum-contract').textContent = '₺' + fmt(ct.final_total);

        // Breakdown table
        const vc = sys.vehicle_count;
        const tbody = document.getElementById('breakdown-body');
        tbody.innerHTML = '';

        const rows = [
            { section: '{{ t["sect_personnel"] }}' },
            { label: '{{ t["lbl_driver_salary"] }}', unit: fmt(bd.driver.gross_salary), qty: vc, total: bd.driver.gross_salary * vc },
            { label: '{{ t["lbl_sgk"] }}', unit: fmt(bd.driver.sgk_per_driver), qty: vc, total: bd.driver.sgk_per_driver * vc },
            { label: '{{ t["lbl_unemployment"] }}', unit: fmt(bd.driver.unemployment_per_driver), qty: vc, total: bd.driver.unemployment_per_driver * vc },
            { label: '{{ t["row_personnel_total"] }}', total: bd.driver.total, bold: true },

            { section: '{{ t["sect_vehicle"] }}' },
            { label: '{{ t["lbl_vehicle_rent"] }}', unit: fmt(bd.vehicle.rent_per_vehicle), qty: vc, total: bd.vehicle.rent_total },
            { label: '{{ t["lbl_maintenance"] }}', unit: fmt(bd.vehicle.maintenance_per_vehicle), qty: vc, total: bd.vehicle.maintenance_total },
            { label: '{{ t["lbl_mtv"] }}', unit: fmt(bd.vehicle.mtv_per_vehicle), qty: vc, total: bd.vehicle.mtv_total },
            { label: '{{ t["row_vehicle_total"] }}', total: bd.vehicle.total, bold: true },

            { section: '{{ t["sect_fuel"] }}' },
            { label: '{{ t["row_fuel_monthly"] }}', unit: fmt(bd.fuel.liters_monthly) + ' lt', qty: '', total: bd.fuel.total },

            { section: '{{ t["sect_total_tax"] }}' },
            { label: '{{ t["row_subtotal"] }}', total: bd.subtotal, bold: true },
            { label: '{{ t["lbl_overhead"] }} (%' + data.params.overhead_rate + ')', total: bd.overhead },
            { label: '{{ t["row_net_cost"] }}', total: bd.net_cost, bold: true },
            { label: '{{ t["lbl_profit"] }} (%' + data.params.profit_rate + ')', total: bd.profit },
            { label: '{{ t["row_pre_tax"] }}', total: bd.pre_tax_total, bold: true },
            { label: '{{ t["lbl_kdv"] }} (%' + data.params.kdv_rate + ')', total: bd.kdv },
            { label: '{{ t["row_grand_total"] }}', total: bd.grand_total_monthly, highlight: true },
        ];

        rows.forEach(r => {
            const tr = document.createElement('tr');
            if (r.section) {
                tr.innerHTML = `<td colspan="4" class="cr-section-row">${r.section}</td>`;
            } else if (r.highlight) {
                tr.classList.add('cr-highlight-row');
                tr.innerHTML = `<td colspan="3"><strong>${r.label}</strong></td><td style="text-align:right"><strong>₺${fmt(r.total)}</strong></td>`;
            } else {
                const cls = r.bold ? ' class="cr-subtotal-row"' : '';
                tr.innerHTML = `
                    <td${cls}>${r.bold ? '<strong>' + r.label + '</strong>' : r.label}</td>
                    <td${cls}>${r.unit || ''}</td>
                    <td${cls}>${r.qty !== undefined && r.qty !== '' ? r.qty + ' araç' : ''}</td>
                    <td${cls} style="text-align:right">${r.bold ? '<strong>' : ''}₺${fmt(r.total)}${r.bold ? '</strong>' : ''}</td>
                `;
            }
            tbody.appendChild(tr);
        });

        // Contract table
        const ctbody = document.getElementById('contract-body');
        ctbody.innerHTML = '';

        const contractRows = [
            { label: '{{ t["row_offer_monthly"] }}', value: ct.monthly_total },
            { label: `{{ t["lbl_contract_months"] }}`, value: ct.months + ' {{ t["unit_months"] }}', raw: true },
            { label: '{{ t["row_contract_val"] }}', value: ct.contract_value },
            { label: `{{ t["lbl_stamp"] }} (%${data.params.stamp_tax_rate})`, value: ct.stamp_tax },
            { label: '{{ t["row_offer_total"] }}', value: ct.final_total, highlight: true },
            { sep: true },
            { label: '{{ t["row_cost_per_emp"] }}', value: ct.per_employee_monthly },
            { label: '{{ t["row_cost_per_veh"] }}', value: ct.per_vehicle_monthly },
            { label: '{{ t["row_cost_per_km"] }}', value: ct.per_km },
        ];

        contractRows.forEach(r => {
            const tr = document.createElement('tr');
            if (r.sep) {
                tr.innerHTML = `<td colspan="2" style="border-bottom:2px solid var(--border-light);padding:4px;"></td>`;
            } else if (r.highlight) {
                tr.classList.add('cr-highlight-row');
                tr.innerHTML = `<td><strong>${r.label}</strong></td><td style="text-align:right"><strong>₺${fmt(r.value)}</strong></td>`;
            } else {
                tr.innerHTML = `<td>${r.label}</td><td style="text-align:right">${r.raw ? r.value : '₺' + fmt(r.value)}</td>`;
            }
            ctbody.appendChild(tr);
        });

        // Update print date
        document.querySelector('.print-date').textContent =
            '{{ t["rpt_date"] }}: ' + new Date().toLocaleDateString('{{ lang }}-{{ lang|upper }}', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Auto-load on page open
    calculateReport();
</script>
{% endblock %}
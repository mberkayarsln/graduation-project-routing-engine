{% extends "base.html" %}

{% block title %}{{ t['emp_title'] }} - {{ t['app_title'] }}{% endblock %}
{% block page_title %}{{ t['emp_title'] }}{% endblock %}

{% block header_actions %}
<div class="search-box">
    <input type="text" id="employee-search" placeholder="{{ t['search_placeholder'] }}" onkeyup="filterEmployees()">
</div>
<select id="filter-status" onchange="filterEmployees()">
    <option value="all">{{ t['filter_all'] }}</option>
    <option value="active">{{ t['filter_active'] }}</option>
    <option value="excluded">{{ t['filter_excluded'] }}</option>
</select>
{% endblock %}

{% block content %}
<div class="card" id="employee-map-card" style="margin-bottom: 20px;">
    <div class="card-header">
        <h2>{{ t['map_emp_title'] }}</h2>
        <div style="display:flex;gap:10px;align-items:center;">
            <span id="selection-count" style="color:var(--text-muted);font-size:13px;"></span>
            <button class="btn btn-secondary btn-sm" onclick="clearSelection()" id="clear-selection-btn"
                style="display:none;">{{ t['btn_clear'] }}</button>
            <button class="btn btn-danger btn-sm" onclick="excludeSelected()" id="exclude-btn" style="display:none;">{{
                t['btn_exclude_sel'] }}</button>
            <button class="btn btn-success btn-sm" onclick="includeSelected()" id="include-btn" style="display:none;">{{
                t['btn_include_sel'] }}</button>
        </div>
    </div>
    <div class="card-body">
        <div id="employees-map" style="height: 400px; border-radius: 12px; z-index: 1;"></div>
    </div>
</div>

<div class="table-card">
    <table class="data-table" id="employees-table">
        <thead>
            <tr>
                <th>{{ t['tbl_id'] }}</th>
                <th>{{ t['tbl_name'] }}</th>
                <th>{{ t['tbl_location'] }}</th>
                <th>{{ t['tbl_zone'] }}</th>
                <th>{{ t['tbl_cluster'] }}</th>

                <th>{{ t['tbl_status'] }}</th>
                <th>{{ t['tbl_actions'] }}</th>
            </tr>
        </thead>
        <tbody id="employees-tbody">
            <tr>
                <td colspan="7" class="loading">{{ t['msg_loading_emp'] }}</td>
            </tr>
        </tbody>
    </table>
</div>

<div id="employee-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">{{ t['modal_emp_title'] }}</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="employee-map" style="height: 300px; border-radius: 12px; margin-bottom: 20px;"></div>

            <form id="employee-form">
                <input type="hidden" id="edit-employee-id">

                <div class="form-group">
                    <label>{{ t['lbl_status'] }}</label>
                    <div class="toggle-group">
                        <label class="toggle">
                            <input type="checkbox" id="edit-excluded">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">{{ t['lbl_excluded_svc'] }}</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="exclusion-reason-group" style="display:none;">
                    <label>{{ t['lbl_reason'] }}</label>
                    <input type="text" id="edit-exclusion-reason" placeholder="{{ t['ph_reason'] }}">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">{{ t['btn_cancel']
                        }}</button>
                    <button type="submit" class="btn btn-primary">{{ t['btn_save'] }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let employees = [];
    let employeeMap = null;
    let mainMap = null;
    let employeeMarkerLayer = null;
    let selectedEmployees = new Set();
    let employeeMarkers = {};

    function updateSelectionUI() {
        const count = selectedEmployees.size;
        document.getElementById('selection-count').textContent = count > 0 ? `${count} seçildi` : '';
        document.getElementById('clear-selection-btn').style.display = count > 0 ? 'inline-flex' : 'none';
        document.getElementById('exclude-btn').style.display = count > 0 ? 'inline-flex' : 'none';
        document.getElementById('include-btn').style.display = count > 0 ? 'inline-flex' : 'none';
    }

    function toggleSelection(empId) {
        if (selectedEmployees.has(empId)) {
            selectedEmployees.delete(empId);
        } else {
            selectedEmployees.add(empId);
        }
        updateMarkerStyle(empId);
        updateSelectionUI();
    }

    function updateMarkerStyle(empId) {
        const marker = employeeMarkers[empId];
        const emp = employees.find(e => e.id === empId);
        if (!marker || !emp) return;

        const isSelected = selectedEmployees.has(empId);
        let color = '#10b981';
        if (isSelected) color = '#3699ff';
        else if (emp.excluded) color = '#f64e60';
        else if (!emp.has_route) color = '#8b5cf6';
        const size = isSelected ? 12 : 8;
        marker.setIcon(L.divIcon({
            className: 'employee-marker',
            html: `<div style="background:${color};width:${size}px;height:${size}px;border-radius:50%;border:${isSelected ? '2' : '1'}px solid #fff;"></div>`,
            iconSize: [size, size],
            iconAnchor: [size / 2, size / 2]
        }));
    }

    function clearSelection() {
        const selected = Array.from(selectedEmployees);
        selectedEmployees.clear();
        selected.forEach(id => updateMarkerStyle(id));
        updateSelectionUI();
        mainMap.closePopup();
    }

    async function excludeSelected() {
        for (const id of selectedEmployees) {
            await fetch(`/api/employees/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ excluded: true, exclusion_reason: 'Haritadan hariç tutuldu' })
            });
        }
        clearSelection();
        loadEmployees();
    }

    async function includeSelected() {
        for (const id of selectedEmployees) {
            await fetch(`/api/employees/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ excluded: false, exclusion_reason: '' })
            });
        }
        clearSelection();
        loadEmployees();
    }

    function initMainMap() {
        mainMap = L.map('employees-map').setView([40.95, 29.2], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap, &copy; CARTO'
        }).addTo(mainMap);
        employeeMarkerLayer = L.layerGroup().addTo(mainMap);

        L.marker([40.837384, 29.412109], {
            icon: L.divIcon({
                className: 'office-marker',
                html: `<div style="background:#3699ff;width:20px;height:20px;border-radius:6px;border:1px solid #fff;display:flex;align-items:center;justify-content:center;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="white"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
                </div>`,
                iconSize: [20, 20], iconAnchor: [10, 10]
            })
        }).addTo(mainMap).bindPopup('<b>{{ t["office"] }}</b>');
    }

    function renderEmployeesOnMap() {
        employeeMarkerLayer.clearLayers();
        employeeMarkers = {};

        employees.forEach(e => {
            const isSelected = selectedEmployees.has(e.id);
            let color = '#10b981';
            if (isSelected) color = '#3699ff';
            else if (e.excluded) color = '#f64e60';
            else if (!e.has_route) color = '#8b5cf6';
            const size = isSelected ? 12 : 8;

            const marker = L.marker([e.lat, e.lon], {
                icon: L.divIcon({
                    className: 'employee-marker',
                    html: `<div style="background:${color};width:${size}px;height:${size}px;border-radius:50%;border:${isSelected ? '2' : '1'}px solid #fff;cursor:pointer;"></div>`,
                    iconSize: [size, size], iconAnchor: [size / 2, size / 2]
                })
            }).addTo(employeeMarkerLayer);

            marker.on('click', function (evt) {
                if (!evt.originalEvent.shiftKey) clearSelection();
                toggleSelection(e.id);
            });
            employeeMarkers[e.id] = marker;
        });
    }

    async function loadEmployees() {
        try {
            const res = await fetch('/api/employees');
            employees = await res.json();
            renderEmployees(employees);
            renderEmployeesOnMap();
        } catch (err) {
            console.error('Error loading employees:', err);
            document.getElementById('employees-tbody').innerHTML =
                '<tr><td colspan="8" class="error">{{ t["msg_err_emp"] }}</td></tr>';
        }
    }

    function renderEmployees(data) {
        const tbody = document.getElementById('employees-tbody');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty">{{ t["msg_no_emp"] }}</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(e => `
        <tr class="${e.excluded ? 'excluded-row' : ''}" onclick="viewOnMap(${e.lat}, ${e.lon}, ${e.id})" style="cursor:pointer;">
            <td>${e.id}</td>
            <td>${e.name}</td>
            <td>${e.lat.toFixed(4)}, ${e.lon.toFixed(4)}</td>
            <td>${e.zone_id || '-'}</td>
            <td>${e.cluster_id || '-'}</td>

            <td>
                <span class="status-badge ${e.excluded ? 'status-excluded' : 'status-active'}">
                    ${e.excluded ? '{{ t["status_excluded"] }}' : '{{ t["status_active"] }}'}
                </span>
            </td>
            <td>
                <button class="btn-icon ${e.excluded ? 'btn-include' : 'btn-exclude'}" 
                        onclick="event.stopPropagation(); toggleExclusion(${e.id}, ${e.excluded})" 
                        title="${e.excluded ? 'Personeli dahil et' : 'Personeli hariç tut'}">
                    ${e.excluded
                ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'}
                </button>
            </td>
        </tr>
    `).join('');
    }

    function filterEmployees() {
        const search = document.getElementById('employee-search').value.toLowerCase();
        const status = document.getElementById('filter-status').value;

        let filtered = employees.filter(e => {
            const matchSearch = e.name.toLowerCase().includes(search) ||
                e.id.toString().includes(search);

            if (status === 'active') return matchSearch && !e.excluded;
            if (status === 'excluded') return matchSearch && e.excluded;
            return matchSearch;
        });

        renderEmployees(filtered);
    }

    function editEmployee(id) {
        const emp = employees.find(e => e.id === id);
        if (!emp) return;

        document.getElementById('modal-title').textContent = `{{ t['modal_edit_title'] }}: ${emp.name}`;
        document.getElementById('edit-employee-id').value = emp.id;
        document.getElementById('edit-excluded').checked = emp.excluded;
        document.getElementById('edit-exclusion-reason').value = emp.exclusion_reason || '';

        document.getElementById('exclusion-reason-group').style.display =
            emp.excluded ? 'block' : 'none';

        document.getElementById('employee-modal').style.display = 'flex';

        setTimeout(() => {
            if (employeeMap) {
                employeeMap.remove();
            }
            employeeMap = L.map('employee-map').setView([emp.lat, emp.lon], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(employeeMap);

            L.marker([emp.lat, emp.lon]).addTo(employeeMap)
                .bindPopup('Ev Konumu').openPopup();

            if (emp.pickup_point && (emp.pickup_point[0] !== emp.lat || emp.pickup_point[1] !== emp.lon)) {
                L.marker([emp.pickup_point[0], emp.pickup_point[1]], {
                    icon: L.divIcon({ className: 'pickup-marker', html: '<div style="background:#10b981;width:10px;height:10px;border-radius:50%;border:2px solid #fff;"></div>', iconSize: [10, 10] })
                }).addTo(employeeMap).bindPopup('Biniş Noktası');
            }
        }, 100);
    }

    function closeModal() {
        document.getElementById('employee-modal').style.display = 'none';
    }

    document.getElementById('edit-excluded').addEventListener('change', function () {
        document.getElementById('exclusion-reason-group').style.display =
            this.checked ? 'block' : 'none';
    });

    document.getElementById('employee-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const id = document.getElementById('edit-employee-id').value;
        const data = {
            excluded: document.getElementById('edit-excluded').checked,
            exclusion_reason: document.getElementById('edit-exclusion-reason').value
        };

        try {
            const res = await fetch(`/api/employees/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                closeModal();
                loadEmployees();
            } else {
                alert('Değişiklikler kaydedilirken hata oluştu');
            }
        } catch (err) {
            console.error('Error:', err);
            alert('Değişiklikler kaydedilirken hata oluştu');
        }
    });

    function viewOnMap(lat, lon, empId) {
        document.getElementById('employee-map-card').scrollIntoView({ behavior: 'smooth' });
        mainMap.setView([lat, lon], 13);

        clearSelection();
        if (empId) {
            toggleSelection(empId);
        }
    }

    async function toggleExclusion(empId, currentlyExcluded) {
        try {
            await fetch(`/api/employees/${empId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    excluded: !currentlyExcluded,
                    exclusion_reason: currentlyExcluded ? '' : 'Tablodan hariç tutuldu'
                })
            });
            await loadEmployees();
        } catch (err) {
            console.error('Error toggling exclusion:', err);
        }
    }

    initMainMap();
    loadEmployees();
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}{{ t['dashboard_title'] }} - {{ t['app_title'] }}{% endblock %}
{% block page_title %}{{ t['dashboard_title'] }}{% endblock %}
{% block page_subtitle %}{{ t['sub_dashboard'] }}{% endblock %}

{% block header_actions %}
<div style="display:flex;align-items:center;gap:10px;">
    <select id="optimization-mode">
        <option value="budget">{{ t['opt_budget'] }}</option>
        <option value="balanced" selected>{{ t['opt_balanced'] }}</option>
        <option value="employee">{{ t['opt_employee'] }}</option>
    </select>
    <button class="btn btn-icon" onclick="refreshStats()" title="{{ t['btn_refresh'] }}">
        <i class="ti ti-refresh"></i>
    </button>
    <button class="btn btn-primary" onclick="generateRoutes()" id="generate-btn">
        <i class="ti ti-plus" style="margin-right:6px;"></i>{{ t['btn_generate'] }}
    </button>
</div>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Map (Left) -->
    <div>
        <div class="card" style="margin-bottom:0;">
            <div id="overview-map" style="height: 600px; border-radius: 12px; z-index: 1;"></div>
        </div>
    </div>

    <!-- Operations Summary (Right) -->
    <div>
        <div class="section-label">{{ t['lbl_ops_summary'] }}</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#E3F2FD;color:#1565C0;">
                        <i class="ti ti-users"></i>
                    </div>
                    <span class="stat-label">{{ t['stat_employees'] }}</span>
                </div>
                <span class="stat-value" id="stat-employees">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#E8F5E9;color:#2E7D32;">
                        <i class="ti ti-user-check"></i>
                    </div>
                    <span class="stat-label">{{ t['stat_active_emp'] }}</span>
                </div>
                <span class="stat-value" id="stat-active">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#FFF3E0;color:#E65100;">
                        <i class="ti ti-user-exclamation"></i>
                    </div>
                    <span class="stat-label">{{ t['lbl_unassigned'] }}</span>
                </div>
                <span class="stat-value" id="stat-unassigned">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#F3E5F5;color:#7B1FA2;">
                        <i class="ti ti-chart-line"></i>
                    </div>
                    <span class="stat-label">{{ t['lbl_efficiency'] }}</span>
                </div>
                <span class="stat-value" id="stat-efficiency">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#E8F5E9;color:#2E7D32;">
                        <i class="ti ti-route"></i>
                    </div>
                    <span class="stat-label">{{ t['stat_routes'] }}</span>
                </div>
                <span class="stat-value" id="stat-routes">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#E3F2FD;color:#1565C0;">
                        <i class="ti ti-bus"></i>
                    </div>
                    <span class="stat-label">{{ t['stat_vehicles'] }}</span>
                </div>
                <span class="stat-value" id="stat-vehicles">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#FFF3E0;color:#E65100;">
                        <i class="ti ti-components"></i>
                    </div>
                    <span class="stat-label">{{ t['nav_clusters'] }}</span>
                </div>
                <span class="stat-value" id="stat-clusters">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#E8F5E9;color:#2E7D32;">
                        <i class="ti ti-map-pin"></i>
                    </div>
                    <span class="stat-label">{{ t['tbl_zone'] }}</span>
                </div>
                <span class="stat-value" id="stat-zones">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#E3F2FD;color:#1565C0;">
                        <i class="ti ti-ruler-measure"></i>
                    </div>
                    <span class="stat-label">{{ t['stat_distance'] }}</span>
                </div>
                <span class="stat-value" id="stat-distance">--</span>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-icon" style="background:#F3E5F5;color:#7B1FA2;">
                        <i class="ti ti-clock"></i>
                    </div>
                    <span class="stat-label">{{ t['stat_duration'] }}</span>
                </div>
                <span class="stat-value" id="stat-duration">--</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const map = L.map('overview-map').setView([40.95, 29.2], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap, &copy; CARTO'
    }).addTo(map);

    let routeLayer = L.layerGroup().addTo(map);

    const officeIcon = L.divIcon({
        className: 'custom-marker office-marker',
        html: `<div style="background:#3699ff;width:20px;height:20px;border-radius:6px;border:1px solid #fff;display:flex;align-items:center;justify-content:center;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="white"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
        </div>`,
        iconSize: [20, 20], iconAnchor: [10, 10]
    });
    L.marker([40.837384, 29.412109], { icon: officeIcon }).addTo(map)
        .bindPopup('<b>{{ t["office"] }}</b>');

    async function refreshStats() {
        try {
            const res = await fetch('/api/stats');
            const data = await res.json();

            document.getElementById('stat-employees').textContent = data.total_employees;
            document.getElementById('stat-active').textContent = data.active_employees;
            document.getElementById('stat-unassigned').textContent = data.unassigned_employees;
            document.getElementById('stat-routes').textContent = data.total_routes;
            document.getElementById('stat-vehicles').textContent = data.total_vehicles;
            document.getElementById('stat-clusters').textContent = data.total_clusters;
            document.getElementById('stat-zones').textContent = data.total_zones;
            document.getElementById('stat-distance').textContent = data.total_distance_km;
            document.getElementById('stat-duration').textContent = Math.round(data.total_duration_min);
            document.getElementById('stat-efficiency').textContent =
                data.total_employees > 0 ?
                    ((data.active_employees - data.unassigned_employees) / data.active_employees * 100).toFixed(1) + '%' : '--';

            loadRoutes();
        } catch (err) {
            console.error('Error loading stats:', err);
        }
    }

    async function loadRoutes() {
        routeLayer.clearLayers();

        try {
            const res = await fetch('/api/routes');
            const routes = await res.json();

            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];

            routes.forEach((route, i) => {
                const color = colors[i % colors.length];

                const pathCoords = route.coordinates && route.coordinates.length > 1 ? route.coordinates : route.stops;
                if (pathCoords && pathCoords.length > 1) {
                    const latlngs = pathCoords.map(s => [s[0], s[1]]);
                    L.polyline(latlngs, {
                        color: color,
                        weight: 3,
                        opacity: 0.8
                    }).addTo(routeLayer);
                }

                if (route.center) {
                    const clusterIcon = L.divIcon({
                        className: 'custom-marker cluster-marker',
                        html: `<div style="background:${color};width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:bold;">${i + 1}</div>`,
                        iconSize: [20, 20]
                    });
                    L.marker([route.center[0], route.center[1]], { icon: clusterIcon }).addTo(routeLayer)
                        .bindPopup(`<b>Rota ${i + 1}</b><br>{{ t['dtl_distance'] }}: ${route.distance_km} {{ t['unit_km'] }}<br>{{ t['dtl_duration'] }}: ${Math.round(route.duration_min)} {{ t['unit_min'] }}`);
                }
            });
        } catch (err) {
            console.error('Error loading routes:', err);
        }
    }

    async function loadOptimizationMode() {
        try {
            const res = await fetch('/api/optimization-mode');
            const data = await res.json();
            const sel = document.getElementById('optimization-mode');
            if (sel && data.current_mode) {
                sel.value = data.current_mode;
            }
        } catch (err) {
            console.error('Error loading optimization mode:', err);
        }
    }

    async function generateRoutes() {
        const btn = document.getElementById('generate-btn');
        const originalText = btn.innerHTML;
        const mode = document.getElementById('optimization-mode').value;

        try {
            btn.innerHTML = '<i class="ti ti-loader" style="margin-right:6px;"></i>{{ t["msg_generating"] }}';
            btn.disabled = true;

            const res = await fetch('/api/generate-routes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode })
            });
            const data = await res.json();

            if (data.success) {
                await refreshStats();
                await loadRoutes();
                showToast('{{ t["msg_gen_success"] }}', 'success');
            } else {
                showToast('Error: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (err) {
            console.error('Error generating routes:', err);
            showToast('{{ t["msg_gen_error"] }}', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    loadOptimizationMode();
    refreshStats();
    loadRoutes();
</script>
{% endblock %}
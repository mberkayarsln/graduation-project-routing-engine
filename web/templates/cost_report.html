{% extends "base.html" %}

{% block title %}Maliyet Raporu - Rota Motoru{% endblock %}
{% block page_title %}Maliyet Raporu{% endblock %}

{% block header_actions %}
<div style="display:flex;align-items:center;gap:10px;">
    <button class="btn btn-primary" onclick="calculateReport()" id="calc-btn">Hesapla</button>
    <button class="btn btn-success" onclick="window.print()">PDF İndir</button>
</div>
{% endblock %}

{% block content %}

<!-- Print Header (hidden on screen, shown on print) -->
<div class="print-header">
    <h1>Personel Servis Hizmeti — Maliyet Raporu</h1>
    <p class="print-date"></p>
</div>

<!-- System Stats Bar -->
<div class="stats-list" id="system-stats">
    <div class="stat-item"><span class="stat-label">Aktif Personel</span><span class="stat-value"
            id="sys-employees">--</span></div>
    <div class="stat-item"><span class="stat-label">Araç Sayısı</span><span class="stat-value"
            id="sys-vehicles">--</span></div>
    <div class="stat-item"><span class="stat-label">Rota Sayısı</span><span class="stat-value" id="sys-routes">--</span>
    </div>
    <div class="stat-item"><span class="stat-label">Günlük Toplam KM</span><span class="stat-value"
            id="sys-daily-km">--</span></div>
    <div class="stat-item"><span class="stat-label">Aylık Toplam KM</span><span class="stat-value"
            id="sys-monthly-km">--</span></div>
</div>

<!-- Editable Parameters -->
<div class="card cr-params-card">
    <div class="card-header">
        <h2>Maliyet Parametreleri</h2>
        <span style="font-size:12px;color:var(--text-muted);">Değerleri düzenleyip "Hesapla" butonuna basın</span>
    </div>
    <div class="card-body">
        <div class="cr-params-grid">
            <div class="cr-param-group">
                <h3 class="cr-param-title">Personel Giderleri</h3>
                <label>Şoför Brüt Maaş (₺/ay)<input type="number" id="p-driver-salary" value="35000"></label>
                <label>SGK İşveren Payı (%)<input type="number" id="p-sgk-rate" value="22.5" step="0.1"></label>
                <label>İşsizlik Sigortası (%)<input type="number" id="p-unemployment" value="2" step="0.1"></label>
            </div>
            <div class="cr-param-group">
                <h3 class="cr-param-title">Araç Giderleri</h3>
                <label>Araç Kirası (₺/ay/araç)<input type="number" id="p-vehicle-rent" value="25000"></label>
                <label>Bakım + Sigorta (₺/ay/araç)<input type="number" id="p-maintenance" value="8000"></label>
                <label>MTV (₺/ay/araç)<input type="number" id="p-mtv" value="1500"></label>
            </div>
            <div class="cr-param-group">
                <h3 class="cr-param-title">Yakıt</h3>
                <label>Yakıt Fiyatı (₺/lt)<input type="number" id="p-fuel-price" value="43.5" step="0.1"></label>
                <label>Tüketim (lt/100km)<input type="number" id="p-fuel-consumption" value="15" step="0.1"></label>
            </div>
            <div class="cr-param-group">
                <h3 class="cr-param-title">Operasyon</h3>
                <label>Aylık İş Günü<input type="number" id="p-working-days" value="22"></label>
                <label>Günlük Sefer (gidiş-dönüş)<input type="number" id="p-trips" value="2"></label>
                <label>Sözleşme Süresi (ay)<input type="number" id="p-contract-months" value="12"></label>
            </div>
            <div class="cr-param-group">
                <h3 class="cr-param-title">Vergi & Kâr</h3>
                <label>Genel Gider (%)<input type="number" id="p-overhead" value="5" step="0.1"></label>
                <label>Kâr Marjı (%)<input type="number" id="p-profit" value="10" step="0.1"></label>
                <label>KDV (%)<input type="number" id="p-kdv" value="20" step="0.1"></label>
                <label>Damga Vergisi (%)<input type="number" id="p-stamp" value="0.948" step="0.001"></label>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="stats-grid cr-summary-grid" id="summary-cards">
    <div class="stat-card">
        <span class="stat-label">Aylık Toplam (KDV Dahil)</span>
        <span class="stat-value" id="sum-monthly">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Personel Başı Aylık</span>
        <span class="stat-value" id="sum-per-emp">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Araç Başı Aylık</span>
        <span class="stat-value" id="sum-per-vehicle">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">KM Başı Maliyet</span>
        <span class="stat-value" id="sum-per-km">--</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Sözleşme Toplam</span>
        <span class="stat-value" id="sum-contract">--</span>
    </div>
</div>

<!-- Detailed Breakdown Table -->
<div class="card">
    <div class="card-header">
        <h2>Maliyet Kalemleri Detayı (Aylık)</h2>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="data-table cr-table" id="breakdown-table">
                <thead>
                    <tr>
                        <th style="width:40%">Kalem</th>
                        <th style="width:20%">Birim Tutar</th>
                        <th style="width:15%">Adet</th>
                        <th style="width:25%;text-align:right">Toplam (₺)</th>
                    </tr>
                </thead>
                <tbody id="breakdown-body">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Contract Summary -->
<div class="card">
    <div class="card-header">
        <h2>İhale Teklif Özeti</h2>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="data-table cr-table" id="contract-table">
                <thead>
                    <tr>
                        <th style="width:60%">Açıklama</th>
                        <th style="width:40%;text-align:right">Tutar (₺)</th>
                    </tr>
                </thead>
                <tbody id="contract-body">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const fmt = (n) => new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    const fmtInt = (n) => new Intl.NumberFormat('tr-TR').format(n);

    async function calculateReport() {
        const btn = document.getElementById('calc-btn');
        btn.textContent = 'Hesaplanıyor...';
        btn.disabled = true;

        try {
            const params = new URLSearchParams({
                driver_salary: document.getElementById('p-driver-salary').value,
                sgk_rate: document.getElementById('p-sgk-rate').value,
                unemployment_rate: document.getElementById('p-unemployment').value,
                vehicle_rent: document.getElementById('p-vehicle-rent').value,
                maintenance: document.getElementById('p-maintenance').value,
                mtv: document.getElementById('p-mtv').value,
                fuel_price: document.getElementById('p-fuel-price').value,
                fuel_consumption: document.getElementById('p-fuel-consumption').value,
                working_days: document.getElementById('p-working-days').value,
                trips_per_day: document.getElementById('p-trips').value,
                contract_months: document.getElementById('p-contract-months').value,
                overhead_rate: document.getElementById('p-overhead').value,
                profit_rate: document.getElementById('p-profit').value,
                kdv_rate: document.getElementById('p-kdv').value,
                stamp_tax_rate: document.getElementById('p-stamp').value,
            });

            const res = await fetch('/api/cost-report?' + params.toString());
            const data = await res.json();

            if (data.error) { alert('Hata: ' + data.error); return; }

            renderReport(data);
        } catch (err) {
            console.error(err);
            alert('Rapor hesaplanırken hata oluştu.');
        } finally {
            btn.textContent = 'Hesapla';
            btn.disabled = false;
        }
    }

    function renderReport(data) {
        const sys = data.system;
        const bd = data.breakdown;
        const ct = data.contract;

        // System stats
        document.getElementById('sys-employees').textContent = fmtInt(sys.active_employees);
        document.getElementById('sys-vehicles').textContent = fmtInt(sys.vehicle_count);
        document.getElementById('sys-routes').textContent = fmtInt(sys.route_count);
        document.getElementById('sys-daily-km').textContent = fmt(sys.daily_km);
        document.getElementById('sys-monthly-km').textContent = fmt(sys.monthly_km);

        // Summary cards
        document.getElementById('sum-monthly').textContent = '₺' + fmt(bd.grand_total_monthly);
        document.getElementById('sum-per-emp').textContent = '₺' + fmt(ct.per_employee_monthly);
        document.getElementById('sum-per-vehicle').textContent = '₺' + fmt(ct.per_vehicle_monthly);
        document.getElementById('sum-per-km').textContent = '₺' + fmt(ct.per_km);
        document.getElementById('sum-contract').textContent = '₺' + fmt(ct.final_total);

        // Breakdown table
        const vc = sys.vehicle_count;
        const tbody = document.getElementById('breakdown-body');
        tbody.innerHTML = '';

        const rows = [
            { section: 'PERSONEL GİDERLERİ' },
            { label: 'Şoför Brüt Maaş', unit: fmt(bd.driver.gross_salary), qty: vc, total: bd.driver.gross_salary * vc },
            { label: 'SGK İşveren Payı', unit: fmt(bd.driver.sgk_per_driver), qty: vc, total: bd.driver.sgk_per_driver * vc },
            { label: 'İşsizlik Sigortası', unit: fmt(bd.driver.unemployment_per_driver), qty: vc, total: bd.driver.unemployment_per_driver * vc },
            { label: 'Personel Giderleri Toplam', total: bd.driver.total, bold: true },

            { section: 'ARAÇ GİDERLERİ' },
            { label: 'Araç Kiralama / Amortisman', unit: fmt(bd.vehicle.rent_per_vehicle), qty: vc, total: bd.vehicle.rent_total },
            { label: 'Bakım + Sigorta (Kasko + Trafik)', unit: fmt(bd.vehicle.maintenance_per_vehicle), qty: vc, total: bd.vehicle.maintenance_total },
            { label: 'MTV (Motorlu Taşıt Vergisi)', unit: fmt(bd.vehicle.mtv_per_vehicle), qty: vc, total: bd.vehicle.mtv_total },
            { label: 'Araç Giderleri Toplam', total: bd.vehicle.total, bold: true },

            { section: 'YAKIT GİDERLERİ' },
            { label: 'Aylık Yakıt Tüketimi', unit: fmt(bd.fuel.liters_monthly) + ' lt', qty: '', total: bd.fuel.total },

            { section: 'TOPLAM & VERGİLER' },
            { label: 'Operasyonel Ara Toplam', total: bd.subtotal, bold: true },
            { label: 'Genel Giderler (%' + data.params.overhead_rate + ')', total: bd.overhead },
            { label: 'Net Maliyet', total: bd.net_cost, bold: true },
            { label: 'Kâr Marjı (%' + data.params.profit_rate + ')', total: bd.profit },
            { label: 'Vergi Öncesi Toplam', total: bd.pre_tax_total, bold: true },
            { label: 'KDV (%' + data.params.kdv_rate + ')', total: bd.kdv },
            { label: 'AYLIK GENEL TOPLAM (KDV DAHİL)', total: bd.grand_total_monthly, highlight: true },
        ];

        rows.forEach(r => {
            const tr = document.createElement('tr');
            if (r.section) {
                tr.innerHTML = `<td colspan="4" class="cr-section-row">${r.section}</td>`;
            } else if (r.highlight) {
                tr.classList.add('cr-highlight-row');
                tr.innerHTML = `<td colspan="3"><strong>${r.label}</strong></td><td style="text-align:right"><strong>₺${fmt(r.total)}</strong></td>`;
            } else {
                const cls = r.bold ? ' class="cr-subtotal-row"' : '';
                tr.innerHTML = `
                    <td${cls}>${r.bold ? '<strong>' + r.label + '</strong>' : r.label}</td>
                    <td${cls}>${r.unit || ''}</td>
                    <td${cls}>${r.qty !== undefined && r.qty !== '' ? r.qty + ' araç' : ''}</td>
                    <td${cls} style="text-align:right">${r.bold ? '<strong>' : ''}₺${fmt(r.total)}${r.bold ? '</strong>' : ''}</td>
                `;
            }
            tbody.appendChild(tr);
        });

        // Contract table
        const ctbody = document.getElementById('contract-body');
        ctbody.innerHTML = '';

        const contractRows = [
            { label: 'Aylık Teklif Bedeli (KDV Dahil)', value: ct.monthly_total },
            { label: `Sözleşme Süresi`, value: ct.months + ' ay', raw: true },
            { label: 'Sözleşme Bedeli (KDV Dahil)', value: ct.contract_value },
            { label: `Damga Vergisi (%${data.params.stamp_tax_rate})`, value: ct.stamp_tax },
            { label: 'İHALE TEKLİF FİYATI (Toplam)', value: ct.final_total, highlight: true },
            { sep: true },
            { label: 'Personel Başı Aylık Maliyet', value: ct.per_employee_monthly },
            { label: 'Araç Başı Aylık Maliyet', value: ct.per_vehicle_monthly },
            { label: 'Kilometre Başı Maliyet', value: ct.per_km },
        ];

        contractRows.forEach(r => {
            const tr = document.createElement('tr');
            if (r.sep) {
                tr.innerHTML = `<td colspan="2" style="border-bottom:2px solid var(--border-light);padding:4px;"></td>`;
            } else if (r.highlight) {
                tr.classList.add('cr-highlight-row');
                tr.innerHTML = `<td><strong>${r.label}</strong></td><td style="text-align:right"><strong>₺${fmt(r.value)}</strong></td>`;
            } else {
                tr.innerHTML = `<td>${r.label}</td><td style="text-align:right">${r.raw ? r.value : '₺' + fmt(r.value)}</td>`;
            }
            ctbody.appendChild(tr);
        });

        // Update print date
        document.querySelector('.print-date').textContent =
            'Rapor Tarihi: ' + new Date().toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Auto-load on page open
    calculateReport();
</script>
{% endblock %}